# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Dart

on:
    push:
        branches: ['master']
        tags:
            - 'v*'
    pull_request:
        branches: ['master']

jobs:
    setup-flutter:
        runs-on: ubuntu-latest
        outputs:
            flutter-version: ${{ steps.flutter-version.outputs.version }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Flutter
              id: flutter-version
              run: |
                  echo "version=$(grep 'flutter:' pubspec.yaml | awk '{print $2}' | tr -d '\"' || echo 'stable')" >> $GITHUB_OUTPUT

    build:
        needs: setup-flutter
        runs-on: ubuntu-latest

        steps:
            # Checkout code
            - name: Checkout code
              uses: actions/checkout@v4

            # Setup Flutter cache
            - name: Cache Flutter dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pub-cache
                      ~/.flutter
                  key: ${{ runner.os }}-flutter-${{ needs.setup-flutter.outputs.flutter-version }}
                  restore-keys: |
                      ${{ runner.os }}-flutter-

            # Install Flutter
            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            # Install dependencies
            - name: Install dependencies
              run: flutter pub get

            # Uncomment this step to verify the use of 'dart format' on each commit.
            # - name: Verify formatting
            #   run: dart format --output=none --set-exit-if-changed .

            # Consider passing '--fatal-infos' for slightly stricter analysis.
            # - name: Analyze project source
            #   run: dart analyze

            # Your project will need to have tests in test/ and a dependency on
            # package:test for this step to succeed. Note that Flutter projects will
            # want to change this to 'flutter test'.
            # - name: Run tests
            #   run: dart test

            # Build Flutter Web
            - name: Build Flutter Web
              run: flutter build web --no-tree-shake-icons

            # Build Docker image using Dockerfile.CI
            - name: Build Docker Image
              run: docker build -f Dockerfile.CI -t apevolo-flutter-web:latest .

            # Upload Docker image as artifact
            - name: Save Docker image
              run: docker save apevolo-flutter-web:latest | gzip > docker-image.tar.gz

            - name: Upload Docker image as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: docker-image
                  path: docker-image.tar.gz
                  retention-days: 1

            # Build web release for GitHub Release
            - name: Compress web build for release
              if: startsWith(github.ref, 'refs/tags/')
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  cd build/web
                  zip -r ../../apevolo-flutter-web-${VERSION}.zip .

            # Upload web build as artifact for release job
            - name: Upload web build artifact
              if: startsWith(github.ref, 'refs/tags/')
              uses: actions/upload-artifact@v4
              with:
                  name: web-build
                  path: apevolo-flutter-web-*.zip
                  retention-days: 1

    # Windows (x64) build job
    build-windows-x64:
        needs: setup-flutter
        runs-on: windows-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Setup Flutter cache
            - name: Cache Flutter dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/AppData/Local/Pub/Cache
                      ~/AppData/Local/flutter
                  key: ${{ runner.os }}-flutter-${{ needs.setup-flutter.outputs.flutter-version }}
                  restore-keys: |
                      ${{ runner.os }}-flutter-

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Enable Windows desktop
              run: flutter config --enable-windows-desktop

            - name: Build Windows
              run: flutter build windows --release

            # 调试构建输出路径
            - name: Debug build directory
              run: |
                  Get-ChildItem -Path build -Recurse -Depth 3 | Where-Object { $_.Name -like "*.exe" -or $_.FullName -like "*Release*" }

            # 修改打包命令以适应实际路径
            - name: Package Windows build
              run: |
                  $VERSION = $env:GITHUB_REF -replace 'refs/tags/', ''

                  # 查找输出目录并验证可执行文件是否存在
                  $exeFiles = Get-ChildItem -Path "build" -Recurse -Include "*.exe"

                  if ($exeFiles.Count -gt 0) {
                    Write-Host "Found executable files:"
                    $exeFiles | ForEach-Object { Write-Host "  $($_.FullName)" }
                    
                    # 找到第一个exe文件所在的目录作为打包根目录
                    $exeDir = $exeFiles[0].Directory.FullName
                    Write-Host "Using directory for packaging: $exeDir"
                    
                    # 创建目标文件夹
                    $packageDir = "windows-package"
                    New-Item -Path $packageDir -ItemType Directory -Force
                    
                    # 复制所有必需的文件到打包目录
                    Copy-Item -Path "$exeDir\*" -Destination $packageDir -Recurse
                    
                    # 确认复制是否成功
                    Write-Host "Files in package directory:"
                    Get-ChildItem -Path $packageDir -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }
                    
                    # 创建自释放批处理文件，帮助用户运行应用
                    $batchContent = @"
                    @echo off
                    echo 启动 Apevolo Flutter 应用...
                    start "" "$($exeFiles[0].Name)"
                    "@
                    Set-Content -Path "$packageDir\启动应用.bat" -Value $batchContent -Encoding ASCII
                    
                    # 打包
                    Set-Location $packageDir
                    7z a -tzip "$env:GITHUB_WORKSPACE\apevolo-flutter-windows-x64-$VERSION.zip" *
                  } else {
                    # 如果找不到exe文件，尝试直接打包Release目录
                    Write-Host "No .exe files found. Trying to find Release directory..."
                    
                    $releaseDirs = Get-ChildItem -Path "build\windows" -Recurse -Include "Release" | Where-Object { $_.PSIsContainer }
                    
                    if ($releaseDirs.Count -gt 0) {
                      $releaseDir = $releaseDirs[0].FullName
                      Write-Host "Found Release directory: $releaseDir"
                      Set-Location $releaseDir
                      
                      # 创建自释放批处理文件
                      $files = Get-ChildItem -Path "."
                      $files | ForEach-Object { Write-Host "  $($_.Name)" }
                      
                      # 查找可能的启动文件
                      $possibleExe = Get-ChildItem -Path "." -Include "*.exe", "*.bat", "runner.exe" -Recurse -ErrorAction SilentlyContinue
                      if ($possibleExe.Count -gt 0) {
                        $launchScript = @"
                      @echo off
                      echo 启动 Apevolo Flutter 应用...
                      start "" "$($possibleExe[0].Name)"
                      "@
                                              Set-Content -Path "启动应用.bat" -Value $launchScript -Encoding ASCII
                                            }
                      
                      # 打包
                      7z a -tzip "$env:GITHUB_WORKSPACE\apevolo-flutter-windows-x64-$VERSION.zip" *
                      } else {
                      Write-Error "Could not find Windows build output directory or executable files"
                      # 尝试直接查找 runner.exe
                      $runnerExe = Get-ChildItem -Path "build" -Recurse -Include "runner.exe" -ErrorAction SilentlyContinue
                      if ($runnerExe.Count -gt 0) {
                        Write-Host "Found runner.exe at: $($runnerExe[0].FullName)"
                        $runnerDir = $runnerExe[0].Directory.FullName
                        Set-Location $runnerDir
                        7z a -tzip "$env:GITHUB_WORKSPACE\apevolo-flutter-windows-x64-$VERSION.zip" *
                      } else {
                        exit 1
                      }
                    }
                  }

            - name: Upload Windows artifact
              uses: actions/upload-artifact@v4
              with:
                  name: windows-x64-build
                  path: apevolo-flutter-windows-x64-*.zip
                  retention-days: 1

    # macOS (Universal - Intel + ARM) build job
    build-macos-universal:
        needs: setup-flutter
        runs-on: macos-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Setup Flutter cache
            - name: Cache Flutter dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pub-cache
                      ~/Library/Developer/Xcode/DerivedData
                      ~/.flutter
                  key: ${{ runner.os }}-flutter-${{ needs.setup-flutter.outputs.flutter-version }}
                  restore-keys: |
                      ${{ runner.os }}-flutter-

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Enable macOS desktop
              run: flutter config --enable-macos-desktop

            - name: Build macOS
              run: flutter build macos --release --no-tree-shake-icons

            # Package as Universal Binary (x64 + arm64)
            - name: Package macOS build as Universal Binary
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  cd build/macos/Build/Products/Release

                  # Check if we can create universal binary
                  if [ -d "*.app" ]; then
                    echo "Creating universal binary package"
                    ditto -c -k --sequesterRsrc --keepParent *.app ../../../../../apevolo-flutter-macos-universal-${VERSION}.zip
                  else
                    echo "Creating standard package (architecture dependent)"
                    ditto -c -k --sequesterRsrc --keepParent *.app ../../../../../apevolo-flutter-macos-${VERSION}.zip
                  fi

            - name: Upload macOS Universal artifact
              uses: actions/upload-artifact@v4
              with:
                  name: macos-build
                  path: apevolo-flutter-macos-*.zip
                  retention-days: 1

    # Linux (x64) build job
    build-linux-x64:
        needs: setup-flutter
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Setup Flutter cache
            - name: Cache Flutter dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pub-cache
                      ~/.flutter
                  key: ${{ runner.os }}-flutter-${{ needs.setup-flutter.outputs.flutter-version }}
                  restore-keys: |
                      ${{ runner.os }}-flutter-

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: Install Linux dependencies
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y ninja-build libgtk-3-dev libblkid-dev liblzma-dev

            - name: Install dependencies
              run: flutter pub get

            - name: Enable Linux desktop
              run: flutter config --enable-linux-desktop

            - name: Build Linux
              run: flutter build linux --release

            - name: Package Linux build
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}
                  cd build/linux/x64/release/bundle
                  tar -czf ../../../../../apevolo-flutter-linux-x64-${VERSION}.tar.gz *

            - name: Upload Linux artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-x64-build
                  path: apevolo-flutter-linux-x64-*.tar.gz
                  retention-days: 1

    # Linux (ARM64) build job
    build-linux-arm64:
        needs: setup-flutter
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Setup Flutter cache
            - name: Cache Flutter dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.pub-cache
                      ~/.flutter
                  key: ${{ runner.os }}-flutter-arm64-${{ needs.setup-flutter.outputs.flutter-version }}
                  restore-keys: |
                      ${{ runner.os }}-flutter-arm64-

            - name: Install Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  cache: true

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v2
              with:
                  platforms: arm64

            - name: Create Dockerfile for ARM64 build
              run: |
                  cat > Dockerfile.arm64 << 'EOF'
                  FROM arm64v8/ubuntu:20.04

                  ENV DEBIAN_FRONTEND=noninteractive

                  # Install dependencies
                  RUN apt-get update && apt-get install -y \
                      curl git unzip xz-utils zip libglu1-mesa wget \
                      ninja-build libgtk-3-dev libblkid-dev liblzma-dev \
                      cmake clang pkg-config libgtk-3-dev \
                      && apt-get clean

                  # Create flutter directory
                  RUN mkdir -p /flutter

                  # Create working directory
                  WORKDIR /app

                  # Copy project files
                  COPY . .

                  ENV PATH="/flutter/bin:${PATH}"

                  # Get dependencies and build
                  RUN cd /app && \
                      flutter config --enable-linux-desktop && \
                      flutter pub get && \
                      flutter build linux --release

                  # Package the app
                  RUN cd build/linux/arm64/release/bundle && \
                      VERSION=$(echo "${CI_TAG}" | sed 's/refs\/tags\///') && \
                      tar -czf /app/apevolo-flutter-linux-arm64-${VERSION:-latest}.tar.gz *
                  EOF

            - name: Setup Flutter for Docker
              run: |
                  FLUTTER_HOME=$HOME/.flutter  # 根据缓存的实际路径调整
                  if [ ! -d "$FLUTTER_HOME" ]; then
                    # 如果缓存没有生效，下载 Flutter
                    git clone https://github.com/flutter/flutter.git $FLUTTER_HOME
                    $FLUTTER_HOME/bin/flutter channel stable
                    $FLUTTER_HOME/bin/flutter upgrade
                  fi

                  # 创建一个 Flutter 归档文件 (SDK)，可以复制到 Docker 中
                  mkdir -p flutter_sdk
                  cp -R $FLUTTER_HOME/* flutter_sdk/

            - name: Build ARM64 version using Docker
              run: |
                  VERSION=${GITHUB_REF#refs/tags/}

                  # 构建 Docker 镜像，将准备好的 Flutter SDK 复制进去
                  docker build -f Dockerfile.arm64 --build-arg CI_TAG=${GITHUB_REF} -t flutter-linux-arm64-builder . \
                    --build-arg FLUTTER_SDK=flutter_sdk

                  # 创建容器
                  docker create --name arm64-builder flutter-linux-arm64-builder

                  # 复制构建结果
                  docker cp arm64-builder:/app/apevolo-flutter-linux-arm64-${VERSION}.tar.gz ./apevolo-flutter-linux-arm64-${VERSION}.tar.gz || \
                  docker cp arm64-builder:/app/apevolo-flutter-linux-arm64-latest.tar.gz ./apevolo-flutter-linux-arm64-${VERSION}.tar.gz

                  # 清理容器
                  docker rm arm64-builder

            - name: Upload Linux ARM64 artifact
              uses: actions/upload-artifact@v4
              with:
                  name: linux-arm64-build
                  path: apevolo-flutter-linux-arm64-*.tar.gz
                  retention-days: 1

    deploy:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'

        steps:
            # Download Docker image artifact
            - name: Download Docker image
              uses: actions/download-artifact@v4
              with:
                  name: docker-image

            - name: Load Docker image
              run: gunzip -c docker-image.tar.gz | docker load

            # Set up SSH
            - name: Set up SSH
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts

            # Deploy Docker Image to Server
            - name: Deploy Docker Image to Server
              env:
                  SERVER_USER: ${{ secrets.SERVER_USER }}
                  SERVER_HOST: ${{ secrets.SERVER_HOST }}
              run: |
                  docker save apevolo-flutter-web:latest | bzip2 | ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST 'bunzip2 | docker load && docker stop apevolo-flutter-web || true && docker rm apevolo-flutter-web || true && docker run -d --name apevolo-flutter-web -p 8001:80 apevolo-flutter-web:latest'

    release:
        needs:
            [
                build,
                build-windows-x64,
                build-macos-universal,
                build-linux-x64,
                build-linux-arm64,
            ]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Get the version from tag
            - name: Get version
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            # Get recent changes for changelog
            - name: Get recent changes
              id: recent_changes
              run: |
                  echo "changelog<<EOF" >> $GITHUB_OUTPUT
                  git log -n 20 --pretty=format:"* %h %s (%an)" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            # Download all build artifacts
            - name: Download web build
              uses: actions/download-artifact@v4
              with:
                  name: web-build

            - name: Download Windows x64 build
              uses: actions/download-artifact@v4
              with:
                  name: windows-x64-build

            - name: Download macOS build
              uses: actions/download-artifact@v4
              with:
                  name: macos-build

            - name: Download Linux x64 build
              uses: actions/download-artifact@v4
              with:
                  name: linux-x64-build

            - name: Download Linux arm64 build
              uses: actions/download-artifact@v4
              with:
                  name: linux-arm64-build

            # List downloaded files
            - name: List files
              run: ls -la

            # Create GitHub Release
            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      apevolo-flutter-web-${{ steps.get_version.outputs.VERSION }}.zip
                      apevolo-flutter-windows-x64-${{ steps.get_version.outputs.VERSION }}.zip
                      apevolo-flutter-macos-universal-${{ steps.get_version.outputs.VERSION }}.zip
                      apevolo-flutter-macos-${{ steps.get_version.outputs.VERSION }}.zip
                      apevolo-flutter-linux-x64-${{ steps.get_version.outputs.VERSION }}.tar.gz
                      apevolo-flutter-linux-arm64-${{ steps.get_version.outputs.VERSION }}.tar.gz
                  name: Release ${{ steps.get_version.outputs.VERSION }}
                  body: |
                      ## Apevolo Flutter ${{ steps.get_version.outputs.VERSION }}

                      ### 📝 更新日志
                      ```
                      ${{ steps.recent_changes.outputs.changelog }}
                      ```

                      ### 📦 可用平台
                      - **Web**
                        - 通用版本 (apevolo-flutter-web-${{ steps.get_version.outputs.VERSION }}.zip)

                      - **Windows**
                        - x64 版本 (apevolo-flutter-windows-x64-${{ steps.get_version.outputs.VERSION }}.zip)

                      - **macOS**
                        - 通用版本 (Intel + Apple Silicon) (apevolo-flutter-macos-universal-${{ steps.get_version.outputs.VERSION }}.zip)

                      - **Linux**
                        - x64 版本 (apevolo-flutter-linux-x64-${{ steps.get_version.outputs.VERSION }}.tar.gz)
                        - ARM64 版本 (apevolo-flutter-linux-arm64-${{ steps.get_version.outputs.VERSION }}.tar.gz)

                      ### 🚀 部署方式
                      #### Web
                      1. 解压 ZIP 文件
                      2. 部署到您的 Web 服务器

                      #### Windows
                      1. 解压 ZIP 文件
                      2. 运行可执行文件

                      #### macOS
                      1. 解压 ZIP 文件
                      2. 移动应用程序到应用程序文件夹

                      #### Linux
                      1. 解压 tar.gz 文件
                      2. 运行可执行文件

                      ### 💻 系统要求
                      - **Windows**: 64位系统
                      - **macOS**: Intel或Apple Silicon芯片的Mac (macOS 10.14或更高版本)
                      - **Linux**: x86_64或ARM64架构
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
